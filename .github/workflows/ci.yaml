name: ci

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'

jobs:
  unit-test:
    runs-on: ubuntu-latest
    steps:
      - 
        name: Checkout code
        uses: actions/checkout@v4
      - 
        name: Install dependencies
        run: |
          cd src
          pip install -r requirements.txt
      - 
        name: Run tests
        run: |
          cd src
          python -m unittest tests/test_app.py

  docker:
    runs-on: ubuntu-latest
    name: docker build and push image
    needs: unit-test  # Ensures docker job runs only if unit-test is successful
    env:      
      DOCKERHUB_IMAGE: ic-webapp
      DOCKERHUB_USERNAME: f3lin
      DOCKERHUB_REPOSITORY: f3lin
    steps:
      - 
        name: Checkout code
        uses: actions/checkout@v4
        
      - 
        name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - 
        name: Automatic Tagging of Releases
        id: increment-git-tag
        run: |
          cd src/scripts
          bash git_update_tag.sh -v patch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
      - 
        name: Build, Tag, and Push the Image to Docker Hub
        id: build-image
        env:
          IMAGE_TAG: ${{ steps.increment-git-tag.outputs.git-tag }}
        run: |
          cd src 
          docker build -t $DOCKERHUB_REPOSITORY/$DOCKERHUB_IMAGE:$IMAGE_TAG .
          docker push $DOCKERHUB_REPOSITORY/$DOCKERHUB_IMAGE:$IMAGE_TAG
